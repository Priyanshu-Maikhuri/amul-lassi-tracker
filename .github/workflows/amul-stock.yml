name: Amul Lassi Stock Checker (Browser)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  check-stock:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          npx playwright install chromium

      - name: Check stock using real browser
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          node << 'EOF'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();

            await page.goto(
              'https://shop.amul.com/en/product/amul-high-protein-plain-lassi-200-ml-or-pack-of-30',
              { waitUntil: 'networkidle' }
            );

            const available = await page.evaluate(async () => {
              const res = await fetch(
                '/api/1/entity/ms.products?q={"alias":"amul-high-protein-plain-lassi-200-ml-or-pack-of-30"}&limit=1'
              );
              const json = await res.json();
              return json.data[0].available;
            });

            console.log('Available:', available);

            if (available > 0) {
              const msg = encodeURIComponent(
                'ðŸŸ¢ Amul High Protein Lassi is IN STOCK!\n\n' +
                'https://shop.amul.com/en/product/amul-high-protein-plain-lassi-200-ml-or-pack-of-30'
              );

              await fetch(
                `https://api.telegram.org/bot${process.env.TELEGRAM_TOKEN}/sendMessage?chat_id=${process.env.TELEGRAM_CHAT_ID}&text=${msg}`
              );
            }

            await browser.close();
          })();
          EOF
