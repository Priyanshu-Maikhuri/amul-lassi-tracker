name: Amul Lassi Stock Checker

on:
  schedule:
    - cron: "*/10 * * * *"   # every 10 minutes
  workflow_dispatch:

jobs:
  check-stock:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Playwright
        run: |
          npm init -y
          npm install playwright
          # This line is mandatory to download the browser itself
          npx playwright install --with-deps chromium

      - name: Check stock using real browser
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          node << 'EOF'
          const { chromium } = require('playwright');

          (async () => {
            const browser = await chromium.launch({ headless: true });
            const context = await browser.newContext();
            const page = await context.newPage();

            try {
              // Listen for the specific background API call the site makes
              const stockPromise = page.waitForResponse(response =>
                response.url().includes('/api/1/entity/ms.products') &&
                response.request().method() === 'GET' &&
                response.status() === 200
              );

              await page.goto(
                'https://shop.amul.com/en/product/amul-high-protein-plain-lassi-200-ml-or-pack-of-30',
                { waitUntil: 'networkidle' }
              );

              const response = await stockPromise;
              const json = await response.json();

              if (!json?.data?.length) {
                throw new Error('Product data missing');
              }

              const available = json.data[0].available;
              console.log('Stock Level:', available);

              if (available > 0) {
                const msg = encodeURIComponent(
                  'ðŸŸ¢ Amul High Protein Lassi is IN STOCK!\n\n' +
                  'https://shop.amul.com/en/product/amul-high-protein-plain-lassi-200-ml-or-pack-of-30'
                );

                await fetch(
                  `https://api.telegram.org/bot${process.env.TELEGRAM_TOKEN}/sendMessage` +
                  `?chat_id=${process.env.TELEGRAM_CHAT_ID}&text=${msg}`
                );
              }

            } catch (err) {
              console.error('Failed to capture stock:', err.message);
              process.exit(1);
            } finally {
              await browser.close();
            }
          })();
          EOF
